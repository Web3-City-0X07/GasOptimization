# 合约编译优化及合约部署优化

网络上关于燃气优化的文章中经常能看到的一项建议是将solidity设置中settings.optimizer.enabled设置为true，将settings.optimizer.runs设置为10000或者更高，这个建议并不是在所有场景下都正确。

settings.optimizer.runs设置是一个燃气优化策略的选择，如果你的合约在部署后运行次数较少，可能只提交少数的交易的话，你可以把这个设置成1或者一个小的数字，如果你的合约部署后期望运行非常多的次数，比如一个ERC20合约，那你可以将这个数字设置为10000或者其他较大的数字。当你设置的数字较小时候，编译器倾向于优化合约的部署成本，让合约的字节码尽量少。当这设置的数字很大的时候，合约倾向于让合约执行尽量的节省燃气。

### 合约部署

让我们来看一下合约部署的基础知识及收费逻辑。首先我们构建一个简单的合约。

```js
pragma solidity ^0.8.24;

contract Case008 {
    uint256 private number;

    constructor(uint256 n) payable {
        number = n;
    }

    function inc() external payable {
        ++number;
    }
}
```

下面是编译后的字节码
```js
// 这是创建合约的代码
0x608060405260405161018838038061018883398181016040528101906100259190610068565b805f8190555050610093565b5f80fd5b5f819050919050565b61004781610035565b8114610051575f80fd5b50565b5f815190506100628161003e565b92915050565b5f6020828403121561007d5761007c610031565b5b5f61008a84828501610054565b91505092915050565b60e98061009f5f395ff3fe608060405260043610601b575f3560e01c8063371303c014601f575b5f80fd5b60256027565b005b5f8081546032906071565b91905081905550565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f819050919050565b5f6079826068565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820360a85760a7603b565b5b60018201905091905056fea26469706673582212202382425d7d625c78e313018661a2b7a139861b6ce25c8bad2daf596e2abd0bd964736f6c63430008180033

// 这是部署后的代码
608060405260043610601b575f3560e01c8063371303c014601f575b5f80fd5b60256027565b005b5f8081546032906071565b91905081905550565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f819050919050565b5f6079826068565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820360a85760a7603b565b5b60018201905091905056fea26469706673582212202382425d7d625c78e313018661a2b7a139861b6ce25c8bad2daf596e2abd0bd964736f6c63430008180033

// 创建的字节码在提交时要拼接上构造方法的参数，我们参数设置为1，如下
0000000000000000000000000000000000000000000000000000000000000001

// 我们可看到创建合约整体的字节码包括3个部分，我们将把门分开来看
// 第1部分 创建合约流程字节码
0x608060405260405161018838038061018883398181016040528101906100259190610068565b805f8190555050610093565b5f80fd5b5f819050919050565b61004781610035565b8114610051575f80fd5b50565b5f815190506100628161003e565b92915050565b5f6020828403121561007d5761007c610031565b5b5f61008a84828501610054565b91505092915050565b60e98061009f5f395ff3fe
// 第2部分 创建后的合约字节码
608060405260043610601b575f3560e01c8063371303c014601f575b5f80fd5b60256027565b005b5f8081546032906071565b91905081905550565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f819050919050565b5f6079826068565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820360a85760a7603b565b5b60018201905091905056fe
// 第3部分 创建后的合约metadata字节码 53bytes
a26469706673582212202382425d7d625c78e313018661a2b7a139861b6ce25c8bad2daf596e2abd0bd964736f6c63430008180033
// 第4部分 构造方法参数
0000000000000000000000000000000000000000000000000000000000000001

```

第1部分构建合约的字节码可以看作是一个模版脚本，来执行部署合约的整个流程，主要负责以下工作：
1. 给变量分配插槽，初始化所有变量为0；
2. 从基础合约到派生合约逐层初始化变量；
3. 从基础合约到派生合约逐层执行构造方法；
4. 将合约代码写入存储；

#### 合约部署的燃气消耗
在Remix中合约部署消耗了 127989gas;

主要以下几个部分
1. 基础交易费 21000gas;
2. calldata燃气消耗 5872gas, 4 * 76(zero byte) + 16 * 348;
3. CREATE操作码 32000gas;
4. 合约字节码+合约metadata字节码共 233bytes，200gas/byte，46600gas;
5. 构造方法里里给number设置1，消耗22100gas;
6. 执行部署过程的燃气消耗 417gas;

可以看到合约的部署除了基础交易费和CREATE操作码费用共53000固定费用外，其他费用主要跟部署合约的字节码长度相关，每个字节200gas的费用相当昂贵，所以当合约运行次数不多的时候更多的降低合约部署费用也是一个很好的选择。

### 测试开启编译优化
在Remix中编译过程将settings.optimizer.runs设置为1和10000之后我们分别看下结果

| Runs   | 部署燃气消耗| inc交易燃气消耗 |
| -------- | -------- | -------- | 
| 不开启  | 127989 | 26309 |
| 1      | 107862 | 26240 |
| 10000  | 119662 | 26240 |

我们可以在结果中发现，开启优化后，部署成本和交易成本都有优化，但当runs=1的时候，部署成本更低，然而两个优化参数下交易成本都一样。

因为上面的合约实在太简单，优化空间不大，我们用一个ERC20合约再测试一下，部署时燃气消耗差异非常大。

| Runs   | 部署燃气消耗| mint交易燃气消耗 | transfer交易燃气消耗 |
| -------- | -------- | -------- | -------- | 
| 不开启  | 1091773 | 71237 | 52100 |
| 1      | 603448 | 70653 | 51686 |
| 10000  | 754529 | 70491 | 51412 |

### 总结
合约部署是很贵的，消耗燃气非常多。在合约部署前要根据合约期望执行次数来设置优化项，并且在不同的优化项都测试一下来对比一下燃气消耗，根据情况来评估一个最佳方案。

合约部署也有一些优化方法，主要的点就是怎么让合约字节码变得更短。这些会在后面的内容讲到。

### 推荐阅读
- [编译构建合约代码过程有变化](https://docs.soliditylang.org/en/v0.8.25/ir-breaking-changes.html#semantic-only-changes)